# API架构设计图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端应用层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │   Web    │  │  Mobile  │  │  Desktop │  │  Python  │       │
│  │  前端    │  │   App    │  │   App    │  │  脚本    │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
└───────┼─────────────┼─────────────┼─────────────┼──────────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                      │
                      │ HTTP/HTTPS
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FastAPI 服务层                                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              主服务 (main.py)                          │    │
│  │              http://localhost:8000                      │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │  统一入口 + 综合接口 + 服务编排                  │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  └───────────┬──────────────────┬─────────────────────────┘    │
│              │                  │                               │
│  ┌───────────▼────────┐  ┌──────▼────────────┐                │
│  │  ASR服务           │  │  LLM服务           │                │
│  │  (asr_api.py)      │  │  (llm_api.py)      │                │
│  │  :8001             │  │  :8002             │                │
│  │  ┌──────────────┐  │  │  ┌──────────────┐ │                │
│  │  │ 语音识别接口 │  │  │  │ 对话接口     │ │                │
│  │  │ 批量识别     │  │  │  │ 历史管理     │ │                │
│  │  │ 模型信息     │  │  │  │ 提示词配置   │ │                │
│  │  └──────────────┘  │  │  └──────────────┘ │                │
│  └────────┬───────────┘  └──────┬────────────┘                │
└───────────┼──────────────────────┼──────────────────────────────┘
            │                      │
            │                      │
            ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务逻辑层                                  │
│                                                                  │
│  ┌──────────────────┐      ┌──────────────────┐                │
│  │  FunASRModule    │      │  LLMInterface     │                │
│  │  (funasr_module) │      │  (llm_interface)  │                │
│  │                  │      │                   │                │
│  │  - 模型加载      │      │  - 客户端初始化   │                │
│  │  - 音频识别      │      │  - 消息发送       │                │
│  │  - 批量处理      │      │  - 历史管理       │                │
│  └────────┬─────────┘      └────────┬──────────┘                │
└───────────┼──────────────────────────┼──────────────────────────┘
            │                          │
            ▼                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      外部依赖层                                  │
│                                                                  │
│  ┌──────────────────┐      ┌──────────────────┐                │
│  │   FunASR库       │      │   OpenAI SDK     │                │
│  │   (ModelScope)   │      │   (兼容接口)     │                │
│  │                  │      │                   │                │
│  │  - Paraformer    │      │  - DeepSeek API  │                │
│  │  - VAD           │      │  - Qwen API      │                │
│  │  - 标点恢复      │      │  - 其他LLM       │                │
│  └──────────────────┘      └──────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

### 1. 简单ASR识别流程

```
客户端
  │
  │ POST /asr/transcribe
  │ { audio_path: "..." }
  ▼
主服务 (main.py)
  │
  │ 调用 asr_model.transcribe()
  ▼
FunASRModule
  │
  │ 加载音频
  │ 模型推理
  ▼
返回文本
  │
  │ { success: true, text: "..." }
  ▼
客户端
```

### 2. 简单LLM对话流程

```
客户端
  │
  │ POST /llm/chat
  │ { message: "你好" }
  ▼
主服务 (main.py)
  │
  │ 调用 llm_client.chat()
  ▼
LLMInterface
  │
  │ 构建消息历史
  │ 调用API
  ▼
OpenAI兼容API (DeepSeek/Qwen)
  │
  │ 生成回复
  ▼
返回回复
  │
  │ { success: true, reply: "..." }
  ▼
客户端
```

### 3. 综合对话流程

```
客户端
  │
  │ POST /conversation
  │ { audio_path: "..." }
  ▼
主服务 (main.py)
  │
  ├─► ASR识别
  │   └─► "你好，最近怎么样"
  │
  ├─► LLM对话
  │   └─► "我很好，谢谢！你呢？"
  │
  │ 返回完整结果
  ▼
  │ {
  │   success: true,
  │   reply: "我很好，谢谢！你呢？",
  │   message: "用户说: 你好，最近怎么样"
  │ }
  ▼
客户端
```

## 模块依赖关系

```
┌─────────────────────────────────────────┐
│              API层                       │
│  ┌────────┐  ┌────────┐  ┌────────┐    │
│  │ main   │  │ asr_api│  │llm_api │    │
│  └───┬────┘  └───┬────┘  └───┬────┘    │
│      │           │           │          │
│      └───────┬───┴───────────┘          │
└──────────────┼──────────────────────────┘
               │
               │ 导入
               ▼
┌─────────────────────────────────────────┐
│           辅助模块                       │
│  ┌────────┐  ┌────────┐                │
│  │ models │  │ utils  │                │
│  └────────┘  └────────┘                │
└─────────────────────────────────────────┘
               │
               │ 导入
               ▼
┌─────────────────────────────────────────┐
│           业务模块                       │
│  ┌──────────────┐  ┌──────────────┐    │
│  │ funasr_module│  │ llm_interface│    │
│  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────┘
```

## 部署模式

### 模式1: 统一部署（推荐）

```
┌─────────────────────┐
│   主服务 :8000      │
│   ┌───────────┐     │
│   │ ASR + LLM │     │
│   │  统一管理  │     │
│   └───────────┘     │
└─────────────────────┘
         │
         │ 单一入口
         ▼
       客户端
```

**优点**:
- 简单易用，单一入口
- 统一配置和管理
- 适合开发和小规模部署

### 模式2: 独立部署

```
┌──────────┐  ┌──────────┐  ┌──────────┐
│ 主服务   │  │ ASR服务  │  │ LLM服务  │
│  :8000   │  │  :8001   │  │  :8002   │
└────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │              │
     └─────────────┴──────────────┘
                   │
                   ▼
                 客户端
```

**优点**:
- 服务解耦，独立扩展
- 可分别部署到不同机器
- 适合生产环境和大规模部署

## 配置层次

```
环境变量 (优先级最高)
    │
    ▼
config.yaml (主要配置)
    │
    ▼
代码默认值 (兜底)
```

## 安全层

```
┌──────────────────────────────────┐
│          可选安全层               │
│  ┌────────────────────────┐      │
│  │  API Key 认证          │      │
│  │  Rate Limiting         │      │
│  │  CORS 策略             │      │
│  │  HTTPS 加密            │      │
│  └────────────────────────┘      │
└──────────────────────────────────┘
                │
                ▼
          FastAPI 服务
```

## 监控和日志

```
┌─────────────────────────────────┐
│         日志系统                 │
│  ┌──────────────────────┐       │
│  │  请求日志            │       │
│  │  错误日志            │       │
│  │  性能指标            │       │
│  └──────────────────────┘       │
└─────────────────────────────────┘
                │
                │ 记录
                ▼
          logs/ 目录
    ┌────────────────────┐
    │  asr_api.log       │
    │  llm_api.log       │
    │  main.log          │
    └────────────────────┘
```
